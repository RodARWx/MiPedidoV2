<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Pedido</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">
    <h2 class="mb-4">Nuevo Pedido</h2>

    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <form th:action="@{/guardar_pedido}" th:object="${pedido}" method="post">

        <!-- DATOS -->
        <div class="card mb-4">
            <div class="card-header">Datos del pedido</div>
            <div class="card-body">

                <div class="mb-3">
                    <label class="form-label">Cliente</label>
                    <input type="text" th:field="*{cliente}" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Tipo</label>
                    <select th:field="*{tipoPedido}" class="form-select" id="tipoPedido" required>
                        <option value="">Seleccione</option>
                        <option value="MESA">En mesa</option>
                        <option value="PARA_LLEVAR">Para llevar</option>
                    </select>
                </div>

                <div class="mb-3" id="mesaContainer">
                    <label class="form-label">Mesa</label>
                    <select name="mesa.idMesa" class="form-select" id="mesaSelect">
                        <option value="">Seleccione</option>
                        <option th:each="m : ${mesasLibres}"
                                th:value="${m.idMesa}"
                                th:text="'Mesa ' + ${m.numero}">
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <!-- PRODUCTOS -->
        <div class="card mb-4">
            <div class="card-header">Productos</div>
            <div class="card-body">

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <select id="productoSelect" class="form-select">
                            <option value="">Producto</option>
                            <option th:each="p : ${productos}"
                                    th:value="${p.idProducto}"
                                    th:data-precio="${p.precio}"
                                    th:data-nombre="${p.nombre}"
                                    th:text="${p.nombre + ' ($' + p.precio + ')'}">
                            </option>
                        </select>
                    </div>

                    <div class="col-md-3">
                        <input type="number" id="cantidadInput" min="1" value="1" class="form-control">
                    </div>

                    <div class="col-md-3">
                        <button type="button" class="btn btn-success w-100" onclick="agregarProducto()">Agregar</button>
                    </div>
                </div>

                <table class="table table-striped">
                    <thead class="table-dark">
                    <tr>
                        <th>Producto</th><th>Precio</th><th>Cant.</th><th>Subtotal</th><th></th>
                    </tr>
                    </thead>
                    <tbody id="tablaProductos">
                        <tr id="sinProductos">
                            <td colspan="5" class="text-center text-muted">No hay productos</td>
                        </tr>
                    </tbody>
                </table>

                <h5 class="text-end">Total: $ <span id="total">0.00</span></h5>
            </div>
        </div>

        <div class="d-flex justify-content-between">
            <a href="/pedidos" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary" id="btnCrear" disabled>Crear pedido</button>
        </div>
    </form>
</div>

<script>
    const tipoPedido = document.getElementById('tipoPedido');
    const mesaContainer = document.getElementById('mesaContainer');
    const tabla = document.getElementById('tablaProductos');
    const totalSpan = document.getElementById('total');
    const btnCrear = document.getElementById('btnCrear');

    let detalles = [];

    tipoPedido.addEventListener('change', () => {
        mesaContainer.style.display = tipoPedido.value === 'PARA_LLEVAR' ? 'none' : 'block';
        if (tipoPedido.value === 'PARA_LLEVAR') document.getElementById('mesaSelect').value = '';
    });

    function agregarProducto() {
        const select = document.getElementById('productoSelect');
        const cantidad = parseInt(document.getElementById('cantidadInput').value);

        if (!select.value || cantidad <= 0) return;

        detalles.push({
            idProducto: select.value,
            nombre: select.selectedOptions[0].dataset.nombre,
            precio: parseFloat(select.selectedOptions[0].dataset.precio),
            cantidad
        });

        renderTabla();
        btnCrear.disabled = false;
    }

    function eliminar(index) {
        detalles.splice(index, 1);
        renderTabla();
        btnCrear.disabled = detalles.length === 0;
    }

    function renderTabla() {
        tabla.innerHTML = '';
        let total = 0;

        detalles.forEach((d, i) => {
            const subtotal = d.precio * d.cantidad;
            total += subtotal;

            tabla.innerHTML += `
                <tr>
                    <td>${d.nombre}</td>
                    <td>${d.precio.toFixed(2)}</td>
                    <td>${d.cantidad}</td>
                    <td>${subtotal.toFixed(2)}</td>
                    <td>
                        <button type="button" class="btn btn-sm btn-danger" onclick="eliminar(${i})">X</button>
                    </td>

                    <input type="hidden" name="detalles[${i}].producto.idProducto" value="${d.idProducto}">
                    <input type="hidden" name="detalles[${i}].cantidad" value="${d.cantidad}">
                </tr>
            `;
        });

        totalSpan.innerText = total.toFixed(2);
    }
</script>

</body>
</html>
